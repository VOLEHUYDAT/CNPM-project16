{% extends 'app/base.html' %}
{% load static %}
{% load humanize %}

{% block sales_dashboard %}
<div class="container my-5" style="padding-top: 50px;">
    <div class="row">
        <h3 class="mb-4">{{ title }}</h3>
        <p class="text-muted">Thống kê số lượng sản phẩm bán được theo tháng.</p>
        <hr>

        <!-- Bộ lọc thời gian -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label>Chọn tháng:</label>
                <select id="monthSelect" class="form-select">
                    <option value="">-- Chọn tháng --</option>
                    {% for m in months %}
                        <option value="{{ m }}">Tháng {{ m }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label>Chọn năm:</label>
                <select id="yearSelect" class="form-select">
                    {% for y in years %}
                        <option value="{{ y }}">{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Biểu đồ -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header text-center fw-bold">Biểu đồ thống kê sản phẩm</div>
                <div class="card-body">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    // Nhận dữ liệu JSON từ backend
    const SALES_DATA = JSON.parse(`{{ sales_data_json|escapejs }}`);

    // Chuẩn hóa dữ liệu theo tháng/năm
    function prepareData(month, year) {
        const filtered = SALES_DATA.filter(
            item => item.month_num == month && item.year_num == year
        );

        const productData = {};
        filtered.forEach(item => {
            productData[item.product_name] = item.total_quantity;
        });

        return {
            labels: Object.keys(productData),
            quantities: Object.values(productData)
        };
    }

    const COLORS = ['#3ac47d', '#f7b924', '#007bff', '#d92550', '#3f6ad8', '#6c757d'];

    let chartInstance = null;

    function updateChart() {
        const month = document.getElementById("monthSelect").value;
        const year = document.getElementById("yearSelect").value;

        if (!month || !year) return;

        const data = prepareData(month, year);

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(
            document.getElementById('pieChart'),
            {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.quantities,
                        backgroundColor: COLORS.slice(0, data.labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Sản phẩm bán ra tháng ${month}/${year}`
                        }
                    }
                }
            }
        );
    }

    // Sự kiện thay đổi
    document.getElementById("monthSelect").addEventListener("change", updateChart);
    document.getElementById("yearSelect").addEventListener("change", updateChart);

    // Tự động set tháng/năm hiện tại và render
    const now = new Date();
    document.getElementById("monthSelect").value = now.getMonth() + 1;
    document.getElementById("yearSelect").value = now.getFullYear();

    updateChart();
</script>

{% endblock sales_dashboard %}
